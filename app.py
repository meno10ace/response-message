import streamlit as st
import google.generativeai as genai

# --- ç”»é¢ã®è¨­å®š ---
st.set_page_config(page_title="è‰¯å­å…ˆç”Ÿã®AIç§˜æ›¸", page_icon="ğŸ‘©â€ğŸ«", layout="centered")
st.title("ğŸ‘©â€ğŸ« è‰¯å­å…ˆç”Ÿã®AIç§˜æ›¸ï¼ˆè¿”ä¿¡ä½œæˆãã‚“ï¼‰")
st.write("ä¿è­·è€…ã‹ã‚‰ã®LINEã‚„ãƒ¡ãƒ¼ãƒ«ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€è¿”ä¿¡ã®æ–¹å‘æ€§ã‚’é¸ã¶ã ã‘ã§AIãŒä¸‹æ›¸ãã‚’ä½œæˆã—ã¾ã™ã€‚")

# --- APIã‚­ãƒ¼ã®å…¥åŠ›ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã«é…ç½®ï¼‰ ---
with st.sidebar:
    st.header("âš™ï¸ è¨­å®š")
    api_key = st.text_input("Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›", type="password")
    st.caption("â€»Google AI Studioã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# --- ãƒ¡ã‚¤ãƒ³ç”»é¢ã®å…¥åŠ›ã‚¨ãƒªã‚¢ ---
parent_message = st.text_area("ğŸ“¥ ä¿è­·è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„", height=150, placeholder="ä¾‹ï¼šã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚æœ¬æ—¥ã®ãƒ¬ãƒƒã‚¹ãƒ³ã§ã™ãŒã€å°‘ã—é…ã‚Œã¦åˆ°ç€ã—ãã†ã§ã™...")

st.write("ğŸ¯ è¿”ä¿¡ã®æ–¹å‘æ€§ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰")
col1, col2, col3 = st.columns(3)
with col1:
    is_accept = st.checkbox("âœ… æ‰¿è«¾ã™ã‚‹ãƒ»OK")
    is_decline = st.checkbox("ğŸ™‡â€â™€ï¸ ãŠæ–­ã‚Šã™ã‚‹ãƒ»è¬ç½ª")
with col2:
    is_thanks = st.checkbox("âœ¨ æ„Ÿè¬ã‚’ä¼ãˆã‚‹")
    is_homework = st.checkbox("ğŸ“š å®¿é¡Œã«ã¤ã„ã¦")
with col3:
    is_fee = st.checkbox("ğŸ’° ãŠæœˆè¬ã«ã¤ã„ã¦")
    is_cheer = st.checkbox("ğŸ“£ è¤’ã‚ã‚‹ãƒ»å¿œæ´")

custom_intent = st.text_input("âœï¸ ãã®ä»–ã€è¿½åŠ ã§ä¼ãˆãŸã„ã“ã¨ï¼ˆä¾‹ï¼šæ¥é€±ã¯ç«æ›œãŒãŠä¼‘ã¿ã§ã™ï¼‰")

# --- ç”Ÿæˆãƒœã‚¿ãƒ³ã¨AIã®å‡¦ç† ---
if st.button("âœ¨ è¿”ä¿¡æ¡ˆã‚’ç”Ÿæˆã™ã‚‹", type="primary"):
    if not api_key:
        st.warning("ğŸ‘ˆ ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    elif not parent_message:
        st.warning("ä¿è­·è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        # é¸æŠã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ã€Œæ–¹å‘æ€§ã€ã®ãƒªã‚¹ãƒˆã‚’ä½œã‚‹
        intents = []
        if is_accept: intents.append("æ‰¿è«¾ã™ã‚‹ãƒ»å•é¡Œãªã„ã“ã¨ã‚’ä¼ãˆã‚‹")
        if is_decline: intents.append("ä¸å¯§ã«ãŠæ–­ã‚Šã™ã‚‹ã€ã¾ãŸã¯è¬ç½ªã™ã‚‹")
        if is_thanks: intents.append("æ—¥é ƒã®æ„Ÿè¬ã‚’ä¼ãˆã‚‹")
        if is_homework: intents.append("å®¿é¡Œã®é€²æ—ã«ã¤ã„ã¦è§¦ã‚Œã‚‹ï¼ˆå„ªã—ãï¼‰")
        if is_fee: intents.append("ãŠæœˆè¬ã«é–¢ã™ã‚‹æ¡ˆå†…ã‚’å«ã‚ã‚‹")
        if is_cheer: intents.append("ç”Ÿå¾’ã®æœ€è¿‘ã®é ‘å¼µã‚Šã‚’è¤’ã‚ã‚‹")
        if custom_intent: intents.append(custom_intent)
        
        intent_text = "ã€".join(intents) if intents else "ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆã‚ã›ãŸè‡ªç„¶ãªè¿”ä¿¡"

        # AIã¸ã®æŒ‡ç¤ºæ›¸ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
        prompt = f"""
        ã‚ãªãŸã¯è‹±èªæ•™å®¤ã®å…ˆç”Ÿã€Œè‰¯å­å…ˆç”Ÿã€ã§ã™ã€‚50ä»£ã®å¥³æ€§ã§ã€ä¿è­·è€…ã«å¯¾ã—ã¦ã¯ä¸å¯§ã§å¯„ã‚Šæ·»ã†ã‚ˆã†ãªã€è¦ªã—ã¿ã‚„ã™ã„æ–‡ä½“ï¼ˆé©åº¦ã«ã€Œï¼ã€ã‚„ã€Œï¼ˆç¬‘ï¼‰ã€ã‚‚ä½¿ã†ï¼‰ã§è©±ã—ã¾ã™ã€‚

        ä»¥ä¸‹ã®ä¿è­·è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã—ã¦ã€è¿”ä¿¡æ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

        ã€ä¿è­·è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
        {parent_message}

        ã€è¿”ä¿¡ã«å«ã‚ãŸã„å†…å®¹ãƒ»æ–¹å‘æ€§ã€‘
        {intent_text}

        ã€æŒ‡ç¤ºã€‘
        - æŒ¨æ‹¶ã‹ã‚‰çµã³ã¾ã§ã€ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ãˆã‚‹å½¢ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
        - ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã«å…±æ„Ÿã—ã€è‡ªç„¶ãªä¼šè©±ã«ãªã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
        - ä»¶åãªã©ã¯ä¸è¦ã§ã™ã€‚LINEã‚„ãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
        """

        try:
            # Gemini APIã®å‘¼ã³å‡ºã—
            genai.configure(api_key=api_key)
            model = genai.GenerativeModel('models/gemini-2.5-flash-lite')
            
            with st.spinner("AIãŒè‰¯å­å…ˆç”Ÿã®è¿”ä¿¡ã‚’è€ƒãˆã¦ã„ã¾ã™..."):
                response = model.generate_content(prompt)
                
            st.success("å®Œæˆã—ã¾ã—ãŸï¼")
            st.text_area("ğŸ“¤ ç”Ÿæˆã•ã‚ŒãŸè¿”ä¿¡æ¡ˆï¼ˆã“ã“ã§ç›´æ¥ç·¨é›†ã‚‚ã€ã‚³ãƒ”ãƒ¼ã‚‚ã§ãã¾ã™ï¼‰", response.text, height=250)
            
        except Exception as e:
            st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")